# task file for master node

# Step 2:
 
  - name: Initialize the kubernetes cluster using kubeadm
    template:
      src: 'templates/initialize-cluster.sh'
      dest: '/initialize-cluster.sh'

  - name: Execute file
    shell: "sh /initialize-cluster.sh"

  - name: Setup kubeconfig for user
    command: "{{ item }}"
    with_items:
      - mkdir -p $HOME/.kube
      - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  

  - name: Install Calico Network Plugin for Pod Networking
    command: 'kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml'
    
  - name: Generate join command
    command: kubeadm token create --print-join-command
    register: join_command

  - name: Output command join worker node
    debug:
      msg: "{{ join_command.stdout }}"

  - name: Copy join command to local file
    local_action: 
        module: copy 
        content: "{{ join_command.stdout }}"
        dest: ./join-command

  - name: Install Metric API server
    command: kubectl apply -f https://raw.githubusercontent.com/techiescamp/kubeadm-scripts/main/manifests/metrics-server.yaml

      